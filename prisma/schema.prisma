// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}


// --- Models ---

model User {
  id                String          @id @default(uuid())
  email             String          @unique
  name              String?
  password          String          // Hashed password
  emailVerified     DateTime?       @map("email_verified")
  image             String?
  role              UserRole        @default(USER)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // REMOVED: Model 'Account' is missing.
  // accounts          Account[]
  // REMOVED: Model 'Session' is missing.
  // sessions          Session[]

  medicalProfile    MedicalProfile?
  // REMOVED: Model 'FacilityUser' is missing.
  // facilityUser      FacilityUser?
  
  incidents         Incident[]      // Incidents raised by the User
  cases             Case[]          @relation("PatientCases") // SOS Cases raised by the User

  @@map("users")
}

model MedicalProfile {
  id                    String    @id @default(uuid())
  userId                String    @unique @map("user_id")
  dateOfBirth           DateTime? @map("date_of_birth")
  bloodType             String?   @map("blood_type")
  allergies             String?
  medications           String?
  conditions            String?
  emergencyContactName  String?   @map("emergency_contact_name")
  emergencyContactPhone String?   @map("emergency_contact_phone")

  user                  User      @relation(fields: [userId], references: [id])
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("medical_profiles")
}

// Facility (Hospital) model - MERGED with PostGIS location
model Facility {
  id            String          @id @default(uuid())
  name          String
  address       String
  city          String
  state         String
  postalCode    String          @map("postal_code")
  country       String          @default("US")
  phone         String
  email         String?
  website       String?
  
  // PostGIS column replaces lat/lng Floats
  location      Unsupported("geography(Point, 4326)") // CRITICAL: For fast spatial queries

  // REMOVED: Model 'FacilityUser' is missing.
  // facilityUsers   FacilityUser[]
  
  incidents     Incident[]
  acceptedCases Case[]          @relation("HospitalCases") // Cases accepted by this facility
  
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // CRITICAL: GIST index for PostGIS performance
  @@index([location], type: Gist)
  @@map("facilities")
}

model Incident {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  facilityId      String?          @map("facility_id")
  assignedToId    String?          @map("assigned_to_id")
  status          IncidentStatus   @default(PENDING)
  priority        Priority         @default(MEDIUM)
  locationLat     Float            @map("location_lat")
  locationLng     Float            @map("location_lng")
  address         String?
  description     String?
  notes           String?
  acceptedAt      DateTime?        @map("accepted_at")
  resolvedAt      DateTime?        @map("resolved_at")

  user            User             @relation(fields: [userId], references: [id])
  facility        Facility?        @relation(fields: [facilityId], references: [id])

  // REMOVED: Model 'FacilityUser' is missing.
  // assignedTo      FacilityUser?    @relation("AssignedIncidents", fields: [assignedToId], references: [id])

  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  @@index([userId])
  @@index([facilityId])
  @@index([status])
  @@map("incidents")
}

// New High-Priority SOS Case model
model Case {
  id             String         @id @default(cuid())
  publicCaseId   String         @unique
  status         CaseStatus     @default(MATCHING)

  userLocation   Unsupported("geography(Point, 4326)") // Location of the SOS call

  patientId      String
  patient        User           @relation("PatientCases", fields: [patientId], references: [id])
  
  // Relate to Facility, not the redundant Hospital model
  hospitalId     String?        @map("facility_id")  
  hospital       Facility?      @relation("HospitalCases", fields: [hospitalId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([hospitalId])
  @@map("cases")
}


// --- Enums ---
enum UserRole {
  USER
  HOSPITAL_STAFF
  ADMIN
}

enum StaffRole {
  STAFF
  DOCTOR
  NURSE
  ADMIN
}

enum IncidentStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CaseStatus {
  MATCHING
  ACCEPTED
  EN_ROUTE
  IN_CARE
  COMPLETED
  CANCELLED
}